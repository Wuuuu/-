### 深入理解 React: 事件机制原理

#### 1.序言

React 有一套自己的事件系统，其事件叫做`合成事件`。为什么 React 要自定义一套事件系统？React 事件是如何注册和触发的？React 事件与原生 DOM 事件有什么区别？

#### 2. DOM 事件流

在了解 React 事件之前，先了解一下 DOM 事件流，其包含三个流程：事件捕获阶段、处于捕获阶段、处于目标阶段和事件冒泡阶段。
**（1）事件捕获阶段、处于目标阶段和事件冒泡阶段**

```HTML
<html>
  <body>
    <div id="outer">
      <p id="inner">Click me!</p>
      </div>
    </body>
  </html>
```

上述代码，点击`<p>`元素，那么 DOM 事件流如下图：![enter image description here](https://img2020.cnblogs.com/blog/898684/202006/898684-20200624143429777-917104228.png)

1.事件捕获阶段：事件对象通过目标节点的祖先 Window 传播到目标的父节点。 2.处于目标阶段：事件对象到达目标节点。如果阻止事件冒泡，那么该事件对象将再次阶段完成后停止传播。 3.事件冒泡阶段：事件对象以相反的顺序从目标节点的父项开始传播，从目标节点的父项开始到 window 结束。

**（2）addEventListener**

DOM 事件流中同时包含了事件捕获阶段和事件冒泡阶段，作为开发者，我们可以选择事件处理函数在哪一个阶段被调用。

** addEventListener()**方法用于为特定元素绑定一个事件处理函数。addEventListener 有三个参数：

```JS
element.addEventListener(event,function, useCapture)
```

参数| 描述 
---- | ----
|event | 必须；字符串，指定事件名<br>**注意**：不要使用“on”前缀。例如，使用”click“而不是“onclick”|
|function|必须；指定要事件触发时执行的函数。<br>当事件对象作为第一个参数传入函数。事件对象的类型取决于特定的事件|
|useCapture|可选；布尔值，指定事件是否在捕获或冒泡阶段执行<br> 可能值：<br> true - 事件句柄在捕获阶段执行<br>false -默认。事件句柄在冒泡阶段执行|

#### 3.React事件概述
React根据W3C规范来定义自己的事件系统，期时间被称之为合成事件（SyntheticEvent）。而其自定义事件系统的动机主要包含以下几个方面：
（1）**抹平不同浏览器之间的兼容差异**。最主要的动机。
（2）**事件“合成”，即事件自定义**。事件合成既可以处理兼容问题，也可以用来自定义事件（例如React里面的onChange事件）
（3）**提供一个抽象平台事件机制**。类似于VirtualDOM抽象了跨平台的渲染方式，合成事件（SyntheticEvent）提供一个抽象的跨平台事件机制。
（4）**可以干预事件的分发**。16版本后引入Fiber架构，React可以用过干预事件的分发以优化用户的交互体验。

> 注：【几乎】所有事件都代理到了document，说明有例外，比如`audio`,`video`标签的一些媒体事件，是document所不具有，这些事件只能够在这些标签上进行代理，但依旧用统一的入口分发函数（dispatchEvent）进行绑定。

#### 4.事件注册
React的事件注册过程主要做了两件事：document上注册，存储事件回调。![enter image description here](https://img2020.cnblogs.com/blog/898684/202006/898684-20200624143507392-911347960.png)